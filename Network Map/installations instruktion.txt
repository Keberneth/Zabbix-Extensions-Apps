Syfte: Beskriver installationsprocessen för att möjliggöra datainsamling från nätverkskartan via Zabbix agent och driftsätta den integrerade Network Map-applikationen.

====================================================
KUND SERVRAR (Zabbix Agent-konfiguration)
====================================================

Linux
------
1. Placera skriptet:
   /etc/zabbix/scripts/linux-network-connections.sh

2. Säkerställ exekveringsrättigheter:
   chmod +x /etc/zabbix/scripts/linux-network-connections.sh

3. Lägg till UserParameter:
   Fil: /etc/zabbix/zabbix_agentd.d/linux-network-connections-param.conf

   Innehåll:
   UserParameter=linux-network-connections,/etc/zabbix/scripts/linux-network-connections.sh

4. Starta om Zabbix Agent:
   systemctl restart zabbix-agent


Windows
--------
1. Placera skriptet:
   C:\Program Files\Zabbix Agent 2\scripts\windows-network-connections.ps1

2. Lägg till UserParameter:
   Fil: C:\Program Files\Zabbix Agent 2\zabbix_agent2.d\windows-network-connections-param.conf

   Innehåll:
   UserParameter=windows-network-connections,powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\windows-network-connections.ps1"

3. Starta om Zabbix Agent 2:
   Restart-Service "Zabbix Agent 2"

====================================================
ZABBIX SERVER – Network Map API / Rapportmotor
====================================================

1. Skapa mappar på Zabbix-servern
---------------------------------
mkdir -p /opt/network_map
mkdir -p /opt/network_map/static
mkdir -p /opt/network_map/reports
mkdir -p /opt/network_map/__pycache__

2. Installera Python-bibliotek
------------------------------
Exempel (justera efter din miljö):

pip install fastapi uvicorn requests openpyxl networkx

Obs: ipaddress, xml.etree, json, datetime m.fl. ingår i standardbiblioteket.

3. Lägg till applikationsfiler
------------------------------
Kopiera följande Python-filer till /opt/network_map:

/opt/network_map/main.py
/opt/network_map/config.py
/opt/network_map/helpers.py
/opt/network_map/state.py
/opt/network_map/netbox_integration.py
/opt/network_map/zabbix_integration.py
/opt/network_map/workers.py
/opt/network_map/routes_core.py
/opt/network_map/routes_netbox.py
/opt/network_map/routes_zabbix.py
/opt/network_map/report_config.py
/opt/network_map/report_data.py
/opt/network_map/report_builders.py
/opt/network_map/report_generator.py

Kopiera frontend-filer till /opt/network_map/static:

/opt/network_map/static/index.html
/opt/network_map/static/styles.css
/opt/network_map/static/app.js
/opt/network_map/static/bootstrap.min.css
/opt/network_map/static/cytoscape.min.js
/opt/network_map/static/cytoscape-cose-bilkent.js

4. Testa applikationen manuellt
-------------------------------
Byt till mappen:

cd /opt/network_map

Starta applikationen:

python3 -m uvicorn main:app --host 0.0.0.0 --port 8000

Kontrollera att den lyssnar:

ss -tunlp | grep 8000

Du ska se något i stil med:
0.0.0.0:8000  LISTEN

Avsluta med Ctrl+C när du är klar med testet.

5. Skapa systemd-tjänst
------------------------
Skapa filen:
/etc/systemd/system/network_map.service

Innehåll:

[Unit]
Description=Zabbix Network Map API
After=network.target

[Service]
User=root
WorkingDirectory=/opt/network_map
ExecStart=/usr/bin/env python3.12 -m uvicorn main:app --host 0.0.0.0 --port 8000
Restart=always
Environment="PYTHONUNBUFFERED=1"

[Install]
WantedBy=multi-user.target


Ladda om systemd, aktivera och starta tjänsten:

systemctl daemon-reload
systemctl enable network_map.service
systemctl restart network_map.service
systemctl status network_map.service

6. Nginx-konfiguration (reverse proxy)
--------------------------------------
Skapa filen:
/etc/nginx/conf.d/network_map.conf

Se exempel i separat nginx.conf (anpassa server_name/certifikatvägar).

Tillåt Nginx att ansluta till API (om SELinux är aktivt):

setsebool -P httpd_can_network_connect 1

Validera Nginx-konfiguration och starta om:

nginx -t
systemctl restart nginx

7. Behörigheter
----------------
Se till att Nginx/OS-användaren kan läsa /opt/network_map:

chown nginx:nginx -R /opt/network_map/
chmod 755 -R /opt/network_map/

8. Bakgrundsjobb (integrerat – ingen cron krävs)
------------------------------------------------
I den nya versionen är all schemalagd funktionalitet integrerad som bakgrundstrådar i applikationen (se `workers.py`):

- Zabbix-worker:
  - Hämtar 24 timmar Zabbix-data för nätverkskartan med jämna intervall (standard: var 30:e minut).
- NetBox-worker:
  - Uppdaterar VM/tjänst-data från NetBox (standard: 1 gång per dygn).
- Rapport-worker:
  - Kör `generate_all_reports()` vid start och därefter schemalagt (standard: dagligen runt 02:00).
  - Rapporter skrivs till `/opt/network_map/reports`.

Ingen separat cronjob eller separat `network-map-report.py` behövs längre – rapportmotorn ligger i:
- `report_config.py`
- `report_data.py`
- `report_builders.py`
- `report_generator.py`


# selinux fix
chcon -R -t httpd_sys_content_t /opt/network_map
semanage fcontext -a -t httpd_sys_content_t "/opt/network_map(/.*)?"
restorecon -R /opt/network_map

# Install Python and pip
python3.12 -m pip install --upgrade pip

python3.12 -m pip install \
  fastapi \
  "uvicorn[standard]" \
  requests \
  openpyxl \
  networkx \
  numpy \
  scipy
